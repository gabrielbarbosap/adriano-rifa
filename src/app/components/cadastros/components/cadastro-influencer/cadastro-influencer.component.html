<nb-layout>
  <nb-layout-column>
    <nb-card>
      <nb-card-header>Cadastro do Influencer</nb-card-header>
      <nb-card-body>
        <nb-tabset fullWidth>
          <nb-tab tabTitle="Principal">
            <form
              *ngIf="cadastroForm"
              [formGroup]="cadastroForm"
              (ngSubmit)="onSubmit()"
            >
              <!-- Dados Pessoais -->
              <h4>Dados Pessoais</h4>
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="cpf">CPF *</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="CPF"
                    formControlName="cpf"
                  />
                  <div
                    *ngIf="
                      cadastroForm.get('cpf')?.hasError('invalidCpf') &&
                      cadastroForm.get('cpf')?.touched
                    "
                  >
                    <small class="text-danger">CPF inválido!</small>
                  </div>
                </div>
                <div class="form-group col-md-4">
                  <label for="data_nascimento">Data de Nascimento </label>
                  <input
                    nbInput
                    fullWidth
                    type="date"
                    formControlName="data_nascimento"
                  />
                </div>
                <div class="form-group col-md-4">
                  <nb-checkbox
                    style="align-items: center; margin-top: 22px"
                    status="basic"
                    formControlName="ativo"
                    >Ativo</nb-checkbox
                  >
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="nome_completo">Nome Completo *</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Nome Completo"
                    formControlName="nome_completo"
                  />
                  <div
                    *ngIf="
                      cadastroForm.get('nome_completo')?.invalid &&
                      cadastroForm.get('nome_completo')?.touched
                    "
                  >
                    <small class="text-danger"
                      >Nome completo é obrigatório.</small
                    >
                  </div>
                </div>
                <div class="form-group col-md-4">
                  <label for="rg">RG</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="RG"
                    formControlName="rg"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
                <div class="form-group col-md-4">
                  <label for="titulo_eleitor">Título de Eleitor</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Título de Eleitor"
                    formControlName="titulo_eleitor"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
              </div>

              <h4>Dados Bancários</h4>
              <div class="form-row">
                <div class="form-group col-md-3">
                  <label for="banco">Banco </label>
                  <nb-select
                    fullWidth
                    placeholder="Selecione o banco"
                    formControlName="banco"
                  >
                    <nb-option
                      *ngFor="let bancos of bancos"
                      value="{{ bancos.codigo }}"
                      >{{ bancos.nome }}</nb-option
                    >
                  </nb-select>
                </div>
                <div class="form-group col-md-3">
                  <label for="agencia">Agência </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Agência"
                    formControlName="agencia"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="conta">Conta </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="conta"
                    formControlName="conta"
                  />
                </div>

                <div class="form-group col-md-3">
                  <label for="chave_pix">Chave PIX </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Chave PIX"
                    formControlName="chave_pix"
                  />
                </div>
              </div>

              <!-- Dados Cadastrais Pessoais -->
              <h4>Dados Cadastrais</h4>
              <div class="form-row">
                <div class="form-group col-md-3">
                  <label for="cep">CEP </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="CEP"
                    formControlName="cep"
                    maxlength="8"
                  />
                </div>
                <div class="form-group col-md-6">
                  <label for="endereco">Endereço </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Endereço"
                    formControlName="endereco"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="numero">Número </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Número"
                    formControlName="numero"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-3">
                  <label for="complemento">Complemento </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Complemento"
                    formControlName="complemento"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
                <div class="form-group col-md-3">
                  <label for="bairro">Bairro </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Bairro"
                    formControlName="bairro"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="cidade">Cidade </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Cidade"
                    formControlName="cidade"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="uf">UF </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="UF"
                    formControlName="uf"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="email">Email </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Email"
                    formControlName="email"
                  />
                </div>
                <div class="form-group col-md-4">
                  <label for="fone_movel">Telefone Móvel </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Telefone Móvel"
                    formControlName="fone_movel"
                    mask="(00)0 0000-0000"
                  />
                </div>

                <div class="form-group col-md-4">
                  <label for="inicio_contrato"
                    >Data de Início de Contrato
                  </label>
                  <input
                    nbInput
                    type="date"
                    fullWidth
                    formControlName="inicio_contrato"
                  />
                </div>
              </div>

              <!-- Dados de Contato -->
              <h4>Dados de Contato</h4>
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="contato">Nome do Contato </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Nome do Contato"
                    formControlName="contato"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
                <div class="form-group col-md-4">
                  <label for="telefone_contato">Telefone do Contato</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Telefone do Contato"
                    formControlName="telefone_contato"
                    mask="(00) 0000-0000"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
                <div class="form-group col-md-4">
                  <label for="celular_contato">Celular do Contato</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Celular do Contato"
                    formControlName="celular_contato"
                    mask="(00)0 0000-0000"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-12">
                  <label for="email_contato">Email do Contato</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Email do Contato"
                    formControlName="email_contato"
                  />
                </div>
              </div>

              <!-- Dados Cadastrais da Empresa -->
              <h4>Dados da Empresa</h4>
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="cnpj">CNPJ </label>
                  <input
                    nbInput
                    fullWidth
                    (blur)="consultaCnpj()"
                    placeholder="CNPJ"
                    formControlName="cnpj"
                    maxlength="14"
                  />
                </div>
                <div class="form-group col-md-4">
                  <label for="razao_social">Razão Social </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Razão Social"
                    formControlName="razao_social"
                  />
                </div>
                <div class="form-group col-md-4">
                  <label for="nome_fantasia">Nome Fantasia </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Nome Fantasia"
                    formControlName="nome_fantasia"
                  />
                </div>

                <div class="form-group col-md-4">
                  <label for="produto">Produto </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Produto"
                    formControlName="produto"
                  />
                </div>
              </div>

              <h5>Endereço da Empresa</h5>
              <div class="form-row">
                <div class="form-group col-md-3">
                  <label for="cep_empresa">CEP </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="CEP"
                    formControlName="cep_empresa"
                    maxlength="8"
                  />
                </div>
                <div class="form-group col-md-6">
                  <label for="endereco_pj">Endereço </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Endereço"
                    formControlName="endereco_pj"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="numero_pj">Número </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Número"
                    formControlName="numero_pj"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-3">
                  <label for="complemento_pj">Complemento</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Complemento"
                    formControlName="complemento_pj"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
                <div class="form-group col-md-3">
                  <label for="bairro_pj">Bairro </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Bairro"
                    formControlName="bairro_pj"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="cidade_pj">Cidade </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Cidade"
                    formControlName="cidade_pj"
                  />
                </div>
                <div class="form-group col-md-3">
                  <label for="uf_pj">UF </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="UF"
                    formControlName="uf_pj"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="email_pj">Email da Empresa </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Email da Empresa"
                    formControlName="email_pj"
                  />
                </div>
                <div class="form-group col-md-6">
                  <label for="fone_pj">Telefone da Empresa</label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Telefone da Empresa"
                    formControlName="fone_pj"
                    mask="(00) 0000-0000"
                  />
                  <!-- Campo não obrigatório, sem mensagem de erro -->
                </div>
              </div>

              <!-- Dados Adicionais -->
              <h4>Dados Adicionais</h4>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="comissao">Taxa de Regularidade </label>
                  <input
                    nbInput
                    fullWidth
                    placeholder="Comissão"
                    formControlName="comissao"
                  />
                </div>
              </div>

              <h4>Documentos</h4>
              <div formArrayName="documentos" class="form-array-container">
                <div
                  *ngFor="let doc of documentos.controls; let i = index"
                  [formGroupName]="i"
                  class="form-array-item"
                >
                  <!-- Botão de lupa -->
                  <div *ngIf="doc.get('isUploaded')?.value; else fileInput">
                    <nb-icon
                      status="primary"
                      icon="search-outline"
                      style="
                        font-size: 2rem;
                        margin-bottom: 1rem;
                        cursor: pointer;
                      "
                      (click)="
                        openDocumento(
                          doc.get('arquivo')?.value,
                          doc.get('descricao')?.value
                        )
                      "
                    ></nb-icon>
                  </div>

                  <!-- Input de upload -->
                  <ng-template #fileInput>
                    <input
                      nbInput
                      type="file"
                      (change)="onFileChange($event, i)"
                      placeholder="Selecione um arquivo"
                    />
                  </ng-template>

                  <!-- Campo de descrição -->
                  <input
                    nbInput
                    placeholder="Descrição do documento"
                    formControlName="descricao"
                  />
                  <button
                    nbButton
                    status="danger"
                    size="small"
                    type="button"
                    style="margin-bottom: 1rem"
                    (click)="removeDocumento(i)"
                  >
                    Remover
                  </button>
                </div>
              </div>
              <button
                nbButton
                status="success"
                type="button"
                (click)="addDocumento()"
                class="add-document"
              >
                Adicionar Documento
              </button>

              <!-- Botão de submissão -->
              <div class="form-actions">
                <button
                  nbButton
                  class="button-success"
                  type="submit"
                  [disabled]="!cadastroForm.valid"
                >
                  Salvar Dados
                </button>
              </div>

              <!-- Exibe lista de campos inválidos no topo -->
              <div *ngIf="invalidFields.length > 0">
                <p class="text-danger">
                  Campos inválidos: {{ invalidFields.join(", ") }}
                </p>
              </div>
            </form>
          </nb-tab>

          <nb-tab tabTitle="Sócios" [disabled]="!isEditTab">
            <form [formGroup]="cadastroForm">
              <div formArrayName="socios" class="socios-container">
                <div
                  *ngFor="let socio of socios.controls; let i = index"
                  [formGroupName]="i"
                  class="socio-item"
                >
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="nome">Nome </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Nome"
                        formControlName="nome"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="cpf">CPF/CNPJ </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="CPF/CNPJ"
                        formControlName="cpf"
                        (blur)="consultaCnpjSocio(i)"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="data_nascimento">Data de Nascimento </label>
                      <input
                        nbInput
                        type="date"
                        fullWidth
                        formControlName="data_nascimento"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="email">Email </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Email"
                        formControlName="email"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="telefone">Telefone </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Telefone"
                        formControlName="fone"
                        mask="(00) 0000-0000"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="cep">CEP </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="CEP"
                        formControlName="cep"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="endereco">Endereço </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Endereço"
                        formControlName="endereco"
                      />
                    </div>
                    <div class="form-group col-md-6">
                      <label for="complemento">Complemento </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Complemento"
                        formControlName="complemento"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label for="bairro">Bairro </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Bairro"
                        formControlName="bairro"
                      />
                    </div>
                    <div class="form-group col-md-4">
                      <label for="cidade">Cidade </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="Cidade"
                        formControlName="cidade"
                      />
                    </div>
                    <div class="form-group col-md-4">
                      <label for="uf">UF </label>
                      <input
                        nbInput
                        fullWidth
                        placeholder="UF"
                        formControlName="uf"
                      />
                    </div>
                  </div>

                  <div class="form-actions">
                    <button
                      nbButton
                      status="danger"
                      (click)="removeSocio(i, socio)"
                    >
                      Remover Sócio
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button
                  nbButton
                  status="info"
                  type="button"
                  (click)="addSocio()"
                >
                  Adicionar Sócio
                </button>
                <button
                  nbButton
                  status="success"
                  type="button"
                  (click)="salvarSocios()"
                >
                  Salvar Sócios
                </button>
              </div>
            </form>
          </nb-tab>

          <nb-tab tabTitle="Adicional" [disabled]="!isEditTab">
            <form [formGroup]="cadastroForm">
              <textarea
                nbInput
                fullWidth
                placeholder="Informações adicionais"
                formControlName="obs"
              ></textarea>
            </form>
            <div class="form-actions">
              <button
                nbButton
                status="success"
                type="button"
                (click)="salvarInformacoes()"
              >
                Salvar Sócios
              </button>
            </div>
          </nb-tab>
        </nb-tabset>
      </nb-card-body>
    </nb-card>
  </nb-layout-column>
</nb-layout>
